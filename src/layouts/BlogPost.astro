---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/common/BaseHead.astro";
import Footer from "../components/layout/Footer.astro";
import FormattedDate from "../components/common/FormattedDate.astro";
import Header from "../components/layout/Header.astro";
import TagList from "../components/blog/TagList.astro";
import TOC from "../components/blog/TOC.astro";
import SeriesNav from "../components/blog/SeriesNav.astro";
import Comments from "../components/blog/Comments.astro";
import { getCategoryLabel, getSeriesInfo, getPublishedPosts } from "../lib/utils";

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description?: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: any;
  tags?: string[];
  category?: string;
  series?: string;
  seriesOrder?: number;
  headings?: Heading[];
  allPosts?: CollectionEntry<"blog">[];
  currentPost?: CollectionEntry<"blog">;
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  tags = [],
  category,
  series,
  headings = [],
  allPosts = [],
  currentPost,
} = Astro.props;

// Get series info if applicable
const seriesInfo = currentPost && series
  ? getSeriesInfo(getPublishedPosts(allPosts), currentPost)
  : null;

const hasTOC = headings.length > 0;
---

<html lang="ko">
  <head>
    <BaseHead
      title={title}
      description={description || ""}
      image={heroImage}
      type="article"
      publishedTime={pubDate}
      modifiedTime={updatedDate}
      tags={tags}
    />
    <style>
      .post-layout {
        display: grid;
        grid-template-columns: 1fr minmax(auto, 840px) 250px;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .post-sidebar-left {
        display: none;
      }

      .post-main {
        min-width: 0;
      }

      .post-sidebar-right {
        position: relative;
      }

      @media (max-width: 1200px) {
        .post-layout {
          grid-template-columns: 1fr;
          max-width: 900px;
        }
        .post-sidebar-right {
          display: none;
        }
      }

      .hero-image {
        width: 100%;
        margin-bottom: 2rem;
      }

      .hero-image img {
        display: block;
        margin: 0 auto;
        border-radius: 12px;
        box-shadow: var(--box-shadow);
      }

      .content-wrapper {
        padding: 2.5rem;
      }

      @media (max-width: 720px) {
        .content-wrapper {
          padding: 1.5rem;
        }
      }

      .prose {
        width: 100%;
        color: rgb(var(--gray-dark));
      }

      .title {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        text-align: center;
        border-bottom: 1px solid var(--color-border);
      }

      .title h1 {
        margin: 0.5rem 0 1rem;
        font-size: 2.5rem;
        line-height: 1.1;
      }

      .date {
        margin-bottom: 0.5em;
        color: rgb(var(--gray));
        font-size: 0.95rem;
      }

      .last-updated-on {
        font-style: italic;
      }

      .post-meta {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
      }

      .category-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        background: rgb(var(--gray-light));
        color: rgb(var(--gray-dark));
        border-radius: 99px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
      }

      .category-badge:hover {
        background: var(--accent-light-translucent);
        color: var(--accent);
      }

      .tags-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
      }
    </style>
  </head>

  <body>
    <Header />
    <div class="post-layout">
      <aside class="post-sidebar-left"></aside>

      <main class="post-main animate-fade-in-up">
        <article>
          {heroImage && (
            <div class="hero-image">
              <Image width={1020} height={510} src={heroImage} alt="" />
            </div>
          )}

          <div class="content-wrapper glass-card">
            <div class="prose">
              <div class="title">
                <div class="date">
                  <FormattedDate date={pubDate} />
                  {updatedDate && (
                    <div class="last-updated-on">
                      Last updated on <FormattedDate date={updatedDate} />
                    </div>
                  )}
                </div>
                <h1>{title}</h1>
                <div class="post-meta">
                  {category && (
                    <a href={`/categories/${category}/`} class="category-badge">
                      {getCategoryLabel(category)}
                    </a>
                  )}
                </div>
                {tags.length > 0 && (
                  <div class="tags-wrapper">
                    <TagList tags={tags} size="md" />
                  </div>
                )}
              </div>

              {seriesInfo && <SeriesNav series={seriesInfo} />}

              <slot />

              <Comments />
            </div>
          </div>
        </article>
      </main>

      <aside class="post-sidebar-right">
        {hasTOC && <TOC headings={headings} />}
      </aside>
    </div>
    <Footer />
  </body>
</html>
