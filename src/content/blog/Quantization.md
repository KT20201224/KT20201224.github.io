---
title: LLM 양자화
pubDate: 2025-11-06
description: 데이터를 작게 만드는 방법, 양자화
author: KT
tags:
  - test
  - obsidian
---
#### 양자화
과학적으로 양자란 더 이상 나눌 수 없는 에너지나 물질의 최소 단위를 의미합니다. 빛의 최소 단위인 광자(photon)나 전자가 양자에 해당합니다. LLM에서 말하는 양자화는 조금 다른 개념입니다. 우리가 흔히 사용하는 수 체계는 연속적입니다. 이 숫자를 작은 숫자들로 바꿔서 저장하는 기술입니다. 교재에 양자화라고 적혀있기는 하지만, "이산화" 혹은 "단계화"라고 표현하는 것이 더 정확해 보입니다.

기본적인 원리는 비율 맞추기입니다. 온도계가 있다고 가정하겠습니다. 이 온도계는 FP32(32비트)로 저장되는 온도계라 0.0001°C마다 온도를 표시 할 수 있습니다. 매우 정밀하게 측정할 수 있는 온도계이죠. 근데 우리가 이렇게까지 정확한 온도계는 필요가 없습니다. Int8로 저장되는 온도계로 바꾸려고 합니다. 데이터를 어떻게 변환시켜 줘야할까요? 지금 판교 기온이 온도 13.3°C입니다. 이 온도를 변환시켜 보겠습니다.

```
[정밀 온도계] FP32
측정 범위 : -50°C ~ 50°C
눈금 : 0.0001°C 단위

[평범 온도계] Int8
측정 범위 : -50°C ~ 50°C
눈금 : -127 ~ 128
```

###### Step1 : 스케일 계산

```text
1. 전체 범위 = 최댓값 - 최솟값 = 50 - (-50) = 100°C
2. Int 8 범위 = 127 - (-128) = 255
3. 스케일 = 100 / 255 = 0.392
```

###### Step2 : 실제 변환 FP32 -> Int8

```text
1. 최솟값 빼기 : 13.3 - (-50) = 63.3
2. 스케일로 나누기 : 63.3 / 0.392 = 167.47
3. 반올림 : 168(Int8)
   
최종 맵핑 결과 : 13.3°C -> 168
```
###### 역양자화
조립은 분해의 역순이죠. 그대로 반대로 역양자화를 진행시키겠습니다.
```text
1. 스케일 곱하기 : 168 x 0.392 = 65.856
2. 최솟값 더하기 : 65.856 + (-50) = 15.856
   
오차 : 15.856 - 13.3 = 약 2.5°C
```
약 2.5°C의 오차가 생겼네요. 개인적으로 생각했던 것보다는 오차가 큰 것 같은데, 이게 양자화 손실입니다. 숫자를 압축해서 표현하고 다시 복원하는 과정에서 수를 근사치로 잘라내면서 오차가 발생합니다.

#### 양자화의 장점
1. 메모리 절약 : 가장 큰 장점이죠. AI에게 물어본 바로는 GPT-2 Small(124M Param) 기준으로 최대 87.5%가지 절약이 가능하다고 합니다.
2. 속도 향상 : 연산해야할 비트 수 가 물리적으로 줄어드니 연산 속도가 빨라집니다.
#### 양자화의 단점
1. 정확도 손실 : 당장 위 예시만 봐도 오차가 2.5°C였습니다. 복잡한 추론의 경우에는 확실히 부정확해질 수 있을 것 같습니다.
2. 복원 불가능 : 한번 양자화를 진행하면 원본 데이터를 잃습니다. 저장하고 쓴다면, 양자화하는 의미가 없죠.

따라서 모든 레이어를 똑같이 양자화 하는건 좋지 않다고 합니다. 중요도에 따라 적절하게 레이어 별로 양자화 하는게 중요하다고 합니다. 직접 레이어 별로 양자화를 단계별로 테스트 하면서 가는게 제일 안전해 보이네요.